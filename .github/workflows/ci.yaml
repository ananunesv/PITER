name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  frontend:
    name: Frontend (Node/Next)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Cache ~/.npm (extra)
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json', 'frontend/yarn.lock') }}

      - name: Install frontend dependencies (npm ci)
        run: |
          if [ -f frontend/package.json ]; then
            cd frontend
            npm ci
          else
            echo "No frontend/package.json found — skipping frontend install"
          fi

      - name: Run frontend tests (npm test) if present
        run: |
          if [ -f frontend/package.json ] && grep -q "\"test\"" frontend/package.json; then
            cd frontend
            npm test --if-present --silent
          else
            echo "No frontend test script found — skipping frontend tests"
          fi

      - name: Build frontend (npm run build) if present
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000
        run: |
          if [ -f frontend/package.json ] && grep -q "\"build\"" frontend/package.json; then
            cd frontend
            npm run build
          else
            echo "No frontend build script found — skipping build"
          fi

  backend:
    name: Backend (Python / FastAPI)
    runs-on: ubuntu-latest
    needs: []
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}

      - name: Install backend dependencies
        run: |
          if [ -f backend/requirements.txt ]; then
            python -m pip install --upgrade pip
            pip install -r backend/requirements.txt
          else
            echo "No backend/requirements.txt found — skipping pip install"
          fi

      - name: Run backend tests (pytest) if present
        run: |
          # if there is a tests/ folder or pytest installed in requirements, try to run pytest
          if [ -d backend/tests ] || grep -q "pytest" backend/requirements.txt 2>/dev/null; then
            cd backend
            # ensure pytest is installed
            python -c "import pytest" 2>/dev/null || pip install pytest
            pytest -q || (echo "pytest finished with non-zero exit code" && exit 1)
          else
            echo "No backend tests detected — skipping pytest"
          fi

  integration:
    name: Integration (docker-compose)
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and start services with docker-compose
        run: |
          if [ -f docker-compose.yml ]; then
            docker compose up -d --build
          else
            echo "No docker-compose.yml found — skipping integration compose step"
            exit 0
          fi

      - name: Wait for backend to be healthy (simple curl loop)
        run: |
          # adapt endpoint if you have healthcheck route
          backend_url="http://localhost:8000/health" || backend_url="http://localhost:8000"
          tries=0
          until curl -fsS $backend_url >/dev/null 2>&1 || [ $tries -ge 20 ]; do
            tries=$((tries+1))
            echo "waiting for backend... ($tries)"
            sleep 3
          done
          if [ $tries -ge 20 ]; then
            echo "backend did not start in time (tried $tries times)"
            docker compose logs
            exit 1
          fi
          echo "backend reachable"

      - name: Run simple smoke tests
        run: |
          # Place basic integration/smoke tests here (adjust URIs)
          curl -fsS http://localhost:8000/ || echo "root endpoint returned non-200 or not present"

      - name: Tear down compose
        if: always()
        run: |
          if [ -f docker-compose.yml ]; then
            docker compose down --volumes
          fi
